<!DOCTYPE html>
<html>
<head>
  <title>Farming Tycoon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: sans-serif;
    }
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      background-color: #d0f0c0;
      padding: 20px;
    }
    .active {
      display: flex;
    }
    button {
      padding: 12px 24px;
      margin: 10px;
      font-size: 18px;
      border-radius: 12px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .game-ui {
      position: absolute;
      top: 10px;
      left: 10px;
    }
    .field {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      max-width: 360px;
    }
    .tile {
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
    }
    .farmland {
      background: #8b5a2b;
    }
    .grass {
      background: #7cfc00;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border: 2px solid #333;
      border-radius: 12px;
      display: none;
      z-index: 10;
      max-width: 90vw;
      text-align: center;
    }
    .popup.active {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Home Screen -->
  <div id="homeScreen" class="screen active">
    <h1>Farming Tycoon</h1>
    <button onclick="startGame()">Start Game</button>
    <button onclick="showHowToPlay()">How to Play</button>
  </div>

  <!-- How to Play Screen -->
  <div id="howToPlay" class="screen">
    <h2>How to Play</h2>
    <ul>
      <li>Tap brown farmland to choose crops to plant</li>
      <li>Tap grass to place buildings like coops, barns, stores</li>
      <li>Tap a building to upgrade or sell items</li>
      <li>Tap a crop to see time left to harvest and collect when ready</li>
    </ul>
    <button onclick="goHome()">Back</button>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="screen">
    <div class="game-ui">
      <button onclick="goHome()">üè† Home</button>
      <div>Coins: <span id="coins">0</span></div>
    </div>

    <h2>Your Farm</h2>
    <div class="field" id="field"></div>
  </div>

  <!-- Popups -->
  <div id="coopPopup" class="popup"></div>
  <div id="storePopup" class="popup"></div>
  <div id="plantPopup" class="popup"></div>
  <div id="placePopup" class="popup"></div>
  <div id="cropPopup" class="popup"></div>

  <script>
    const screens = {
      home: document.getElementById("homeScreen"),
      how: document.getElementById("howToPlay"),
      game: document.getElementById("gameScreen")
    };

    function showScreen(screenName) {
      for (let screen in screens) screens[screen].classList.remove("active");
      screens[screenName].classList.add("active");
    }

    function goHome() {
      showScreen("home");
      saveGame();
    }

    function showHowToPlay() {
      showScreen("how");
    }

    function startGame() {
      loadGame();
      showScreen("game");
    }

    const field = document.getElementById("field");
    const coinsDisplay = document.getElementById("coins");
    const coopPopup = document.getElementById("coopPopup");
    const storePopup = document.getElementById("storePopup");
    const plantPopup = document.getElementById("plantPopup");
    const placePopup = document.getElementById("placePopup");
    const cropPopup = document.getElementById("cropPopup");

    let coins = 0;
    let eggs = 0;
    let milk = 0;
    let pork = 0;
    let coopLevel = 0;
    let maxCoopLevel = 5;

    // Tiles references by index
    let coopTile = null;
    let storeTile = null;
    let cowBarnTile = null;
    let pigFarmTile = null;

    // Crop data including growing time (in seconds)
    const cropOptions = [
      { emoji: "üåæ", name: "Wheat", cost: 10, growTime: 20 },
      { emoji: "ü•¨", name: "Lettuce", cost: 50, growTime: 40 },
      { emoji: "üåΩ", name: "Corn", cost: 100, growTime: 60 },
      { emoji: "üçì", name: "Strawberries", cost: 1000, growTime: 120 },
      { emoji: "üçé", name: "Apple Tree", cost: 500, growTime: 180 }
    ];

    // Keep track of planted crops and their timers: {tileIndex: {cropIndex, plantedAt, collected}}
    let cropsState = {};

    // Helper to update coins display and save
    function updateStats() {
      coinsDisplay.textContent = coins;
      saveGame();
    }

    // Save/load game from localStorage
    function saveGame() {
      const cropsSave = {};
      for(let i in cropsState) {
        cropsSave[i] = {...cropsState[i]};
      }
      localStorage.setItem("farmCoins", coins);
      localStorage.setItem("farmEggs", eggs);
      localStorage.setItem("farmMilk", milk);
      localStorage.setItem("farmPork", pork);
      localStorage.setItem("coopLevel", coopLevel);
      localStorage.setItem("cropsState", JSON.stringify(cropsSave));
      localStorage.setItem("buildings", JSON.stringify({
        coop: coopTile ? coopTile.dataset.index : null,
        store: storeTile ? storeTile.dataset.index : null,
        cowBarn: cowBarnTile ? cowBarnTile.dataset.index : null,
        pigFarm: pigFarmTile ? pigFarmTile.dataset.index : null
      }));
    }

    function loadGame() {
      coins = parseInt(localStorage.getItem("farmCoins")) || 1000;
      eggs = parseInt(localStorage.getItem("farmEggs")) || 0;
      milk = parseInt(localStorage.getItem("farmMilk")) || 0;
      pork = parseInt(localStorage.getItem("farmPork")) || 0;
      coopLevel = parseInt(localStorage.getItem("coopLevel")) || 0;

      cropsState = JSON.parse(localStorage.getItem("cropsState")) || {};
      const buildings = JSON.parse(localStorage.getItem("buildings")) || {};

      // Clear field before load
      field.innerHTML = "";

      for (let i = 0; i < 25; i++) {
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.dataset.index = i;
        let isFarmland = i % 5 < 3;
        tile.classList.add(isFarmland ? "farmland" : "grass");

        // Load crops
        if(cropsState[i]) {
          let crop = cropOptions[cropsState[i].cropIndex];
          tile.textContent = crop.emoji;
          tile.onclick = () => onCropClick(i);
        }
        // Load buildings
        else if (buildings.coop == i) {
          tile.textContent = "üêî";
          coopTile = tile;
          tile.onclick = showCoopPopup;
        }
        else if (buildings.store == i) {
          tile.textContent = "üè™";
          storeTile = tile;
          tile.onclick = showStorePopup;
        }
        else if (buildings.cowBarn == i) {
          tile.textContent = "üêÑ";
          cowBarnTile = tile;
          tile.onclick = () => alert("Cow Barn - Produces milk every 30s");
        }
        else if (buildings.pigFarm == i) {
          tile.textContent = "üêñ";
          pigFarmTile = tile;
          tile.onclick = () => alert("Pig Farm - Produces pork chops every 60s");
        }
        else {
          tile.onclick = () => onTileClick(tile);
        }
        field.appendChild(tile);
      }
      updateStats();
    }

    // Plant popup logic when farmland clicked
    function onTileClick(tile) {
      if (tile.classList.contains("farmland")) {
        if (tile.textContent) return; // Already planted

        let optionsHtml = cropOptions.map((c, i) => 
          `<button onclick="plantCrop(${tile.dataset.index},${i})">${c.emoji} ${c.name} (${c.cost} coins)</button>`
        ).join("<br>");
        showPopup(plantPopup, `Plant what?<br>${optionsHtml}<br><button onclick='hidePopup(plantPopup)'>Cancel</button>`);
      } else {
        // Grass tile: choose building
        let optionsHtml = `
          <button onclick="placeBuilding(${tile.dataset.index}, 'coop')">Chicken Coop üêî (250 coins)</button><br>
          <button onclick="placeBuilding(${tile.dataset.index}, 'store')">Store üè™ (Free)</button><br>
          <button onclick="placeBuilding(${tile.dataset.index}, 'cow')">Cow Barn üêÑ (2000 coins)</button><br>
          <button onclick="placeBuilding(${tile.dataset.index}, 'pig')">Pig Farm üêñ (10000 coins)</button><br>
          <button onclick='hidePopup(placePopup)'>Cancel</button>
        `;
        showPopup(placePopup, `Place what here?<br>${optionsHtml}`);
      }
    }

    // Plant a crop
    function plantCrop(tileIndex, cropIndex) {
      let crop = cropOptions[cropIndex];
      if (coins < crop.cost) {
        alert("Not enough coins!");
        hidePopup(plantPopup);
        return;
      }
      coins -= crop.cost;
      cropsState[tileIndex] = {
        cropIndex: cropIndex,
        plantedAt: Date.now(),
        collected: false
      };
      // Update tile
      let tile = field.children[tileIndex];
      tile.textContent = crop.emoji;
      tile.onclick = () => onCropClick(tileIndex);
      updateStats();
      hidePopup(plantPopup);
    }

    // When clicking a crop tile
    function onCropClick(tileIndex) {
      let state = cropsState[tileIndex];
      if (!state) return;
      let crop = cropOptions[state.cropIndex];
      let elapsed = (Date.now() - state.plantedAt) / 1000;
      let timeLeft = Math.max(0, crop.growTime - elapsed);
      cropPopup.dataset.tileIndex = tileIndex;
      if(state.collected) {
        alert("Already collected!");
        return;
      }

      if (timeLeft > 0) {
        showPopup(cropPopup, `Time left to harvest: ${Math.ceil(timeLeft)} seconds<br><button onclick="hidePopup(cropPopup)">Close</button>`);
      } else {
        showPopup(cropPopup, `Ready to collect!<br><button onclick="collectCrop(${tileIndex})">Collect</button><br><button onclick="hidePopup(cropPopup)">Cancel</button>`);
      }
    }

    // Collect harvested crop
    function collectCrop(tileIndex) {
      let state = cropsState[tileIndex];
      if (!state || state.collected) return;
      let crop = cropOptions[state.cropIndex];
      state.collected = true;
      coins += crop.cost * 2; // Earn double cost on harvest
      // Clear tile after collecting
      let tile = field.children[tileIndex];
      tile.textContent = "";
      tile.onclick = () => onTileClick(tile);
      delete cropsState[tileIndex];
      updateStats();
      hidePopup(cropPopup);
      alert(`Collected ${crop.name} and earned ${crop.cost * 2} coins!`);
    }

    // Place buildings on grass tiles
    function placeBuilding(tileIndex, type) {
      let tile = field.children[tileIndex];
      hidePopup(placePopup);

      switch(type) {
        case 'coop':
          if (coopTile) {
            alert("You already have a chicken coop!");
            return;
          }
          if(coins < 250) {
            alert("Not enough coins!");
            return;
          }
          coins -= 250;
          tile.textContent = "üêî";
          coopTile = tile;
          tile.onclick = showCoopPopup;
          break;

        case 'store':
          if (storeTile) {
            alert("You already have a store!");
            return;
          }
          tile.textContent = "üè™";
          storeTile = tile;
          tile.onclick = showStorePopup;
          break;

        case 'cow':
          if (cowBarnTile) {
            alert("You already have a cow barn!");
            return;
          }
          if(coins < 2000) {
            alert("Not enough coins!");
            return;
          }
          coins -= 2000;
          tile.textContent = "üêÑ";
          cowBarnTile = tile;
          tile.onclick = () => alert("Cow Barn - Produces milk every 30s");
          break;

        case 'pig':
          if (pigFarmTile) {
            alert("You already have a pig farm!");
            return;
          }
          if(coins < 10000) {
            alert("Not enough coins!");
            return;
          }
          coins -= 10000;
          tile.textContent = "üêñ";
          pigFarmTile = tile;
          tile.onclick = () => alert("Pig Farm - Produces pork chops every 60s");
          break;
      }
      updateStats();
    }

    // Coop popup with upgrade info and upgrade button
    function showCoopPopup() {
      let nextCost = 100 * (coopLevel + 1);
      let content = coopLevel < maxCoopLevel
        ? `Chicken Coop Level ${coopLevel + 1} Upgrade for ${nextCost} coins?<br><button onclick='upgradeCoop()'>Upgrade</button>`
        : `Chicken Coop is at max level (${coopLevel})`;
      showPopup(coopPopup, `${content}<br><button onclick='hidePopup(coopPopup)'>Close</button>`);
    }

    function upgradeCoop() {
      let cost = 100 * (coopLevel + 1);
      if (coins >= cost && coopLevel < maxCoopLevel) {
        coins -= cost;
        coopLevel++;
        updateStats();
        hidePopup(coopPopup);
        alert(`Chicken Coop upgraded to Level ${coopLevel}`);
      } else {
        alert("Cannot upgrade coop.");
      }
    }

    // Store popup to sell all goods
    function showStorePopup() {
      let earnings = eggs * 10 * coopLevel + milk * 100 + pork * 500;
      showPopup(storePopup, `Sell all goods for ${earnings} coins?<br><button onclick='sellGoods()'>Sell All</button><br><button onclick='hidePopup(storePopup)'>Cancel</button>`);
    }

    function sellGoods() {
      let earnings = eggs * 10 * coopLevel + milk * 100 + pork * 500;
      if (earnings === 0) {
        alert("No goods to sell.");
        return;
      }
      coins += earnings;
      eggs = 0;
      milk = 0;
      pork = 0;
      updateStats();
      hidePopup(storePopup);
      alert(`Sold goods for ${earnings} coins!`);
    }

    // Passive generation of goods by buildings
    setInterval(() => {
      if (coopLevel > 0 && coopTile) eggs += coopLevel;
      if (cowBarnTile) milk++;
      if (pigFarmTile) pork++;
      updateStats();
    }, 30000);

    // Utility functions to show/hide popups
    function showPopup(popup, content) {
      popup.innerHTML = content;
      popup.classList.add("active");
    }
    function hidePopup(popup) {
      popup.classList.remove("active");
    }

  </script>
</body>
</html>
